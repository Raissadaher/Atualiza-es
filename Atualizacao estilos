# -*- coding: utf-8 -*-
"""
/***************************************************************************
 Estilos
                                 A QGIS plugin
 Estilos
 Generated by Plugin Builder
                              -------------------
        begin                : 2024-03-15
        git sha              : $Format:%H$
        author               : Raissa Daher Alves
        email                : raissa.alves@goias.gov.br
 ***************************************************************************/
"""

import os.path
from PyQt5.QtWidgets import QGroupBox, QRadioButton, QAction, QComboBox
from qgis.PyQt.QtCore import QSettings, QTranslator, QCoreApplication
from qgis.PyQt.QtGui import QIcon
from qgis.core import QgsVectorLayer, QgsProject
from .resources import *
from .Estilos_dialog2 import EstilosDialog2
from .EstilosCore import EstilosCore


class Estilos:
    """ImplementaÃ§Ã£o principal do plugin Estilos para QGIS."""

    def __init__(self, iface):
        """Inicializa o plugin com a interface QGIS."""
        self.iface = iface
        self.plugin_dir = os.path.dirname(__file__)

        # ConfiguraÃ§Ã£o de traduÃ§Ã£o
        locale = QSettings().value('locale/userLocale')[0:2]
        locale_path = os.path.join(self.plugin_dir, 'i18n', f'Estilos_{locale}.qm')

        if os.path.exists(locale_path):
            self.translator = QTranslator()
            self.translator.load(locale_path)
            QCoreApplication.installTranslator(self.translator)

        self.actions = []
        self.menu = self.tr(u'&Estilos')
        self.first_start = None
        self.dialogo = None
        self.radio_group: QGroupBox = None

    def tr(self, message):
        """MÃ©todo de traduÃ§Ã£o."""
        return QCoreApplication.translate('Estilos', message)

    def add_action(
        self,
        icon_path,
        text,
        callback,
        enabled_flag=True,
        add_to_menu=True,
        add_to_toolbar=True,
        status_tip=None,
        whats_this=None,
        parent=None
    ):
        """Adiciona aÃ§Ã£o ao menu e Ã  barra de ferramentas do QGIS."""
        icon = QIcon(icon_path)
        action = QAction(icon, text, parent)
        action.triggered.connect(callback)
        action.setEnabled(enabled_flag)

        if status_tip:
            action.setStatusTip(status_tip)
        if whats_this:
            action.setWhatsThis(whats_this)
        if add_to_toolbar:
            self.iface.addToolBarIcon(action)
        if add_to_menu:
            self.iface.addPluginToMenu(self.menu, action)

        self.actions.append(action)
        return action

    def initGui(self):
        """Inicializa o plugin na interface QGIS."""
        icon_path = ':/plugins/Estilos/icon.png'
        self.add_action(
            icon_path,
            text=self.tr(u'AtribuiÃ§Ã£o de estilos aos shapefiles'),
            callback=self.run,
            parent=self.iface.mainWindow()
        )
        self.first_start = True

    def unload(self):
        """Remove o plugin do menu e da barra de ferramentas."""
        for action in self.actions:
            self.iface.removePluginMenu(self.tr(u'&Estilos'), action)
            self.iface.removeToolBarIcon(action)

    def run(self):
        """Executa a sequÃªncia: seleÃ§Ã£o de camadas â†’ renomeia â†’ abre janela de estilos."""
        self.selecao_dialogo = EstilosDialog2()
        self.selecao_dialogo.pushButton.clicked.connect(self.renomear_camadas)
        self.popular_combos_selecao()
        self.selecao_dialogo.exec_()

    # ----------------------------------------------------------------------
    # ðŸ”¹ FUNÃ‡ÃƒO PRINCIPAL: Preenche combos com as camadas do QGIS
    # ----------------------------------------------------------------------
    def popular_combos_selecao(self):
        """Preenche automaticamente todos os QComboBox com as camadas vetoriais do QGIS."""

        # Captura todas as camadas vetoriais vÃ¡lidas
        layers = [
            layer for layer in QgsProject.instance().mapLayers().values()
            if isinstance(layer, QgsVectorLayer) and layer.isValid()
        ]
        nomes_layers = [layer.name() for layer in layers]

        if not nomes_layers:
            print("âš ï¸ Nenhuma camada vetorial ativa encontrada no QGIS.")
            return
        else:
            print("âœ… Camadas vetoriais carregadas no projeto:", nomes_layers)

        # Encontra todos os QComboBox existentes na janela (automÃ¡tico)
        combos = self.selecao_dialogo.findChildren(QComboBox)

        if not combos:
            print("âŒ Nenhum QComboBox encontrado no layout .ui.")
            print("Verifique os nomes dos combos no Qt Designer.")
            return

        # Preenche cada combo com as camadas disponÃ­veis
        for combo in combos:
            nome_obj = combo.objectName()
            combo.clear()
            combo.addItem("Selecione...")
            combo.addItems(nomes_layers)
            print(f"âœ… Combo '{nome_obj}' atualizado com {len(nomes_layers)} camadas.")

        print("ðŸŽ¯ Todos os combos foram preenchidos automaticamente com as camadas vetoriais.")

    # ----------------------------------------------------------------------
    def get_layer_by_name(self, nome):
        """Retorna a camada do projeto pelo nome."""
        for layer in QgsProject.instance().mapLayers().values():
            if layer.name() == nome:
                return layer
        return None

    # ----------------------------------------------------------------------
    def renomear_camadas(self):
        """Renomeia as camadas selecionadas e aplica estilos automaticamente."""
        mapping = {
            "Ãrea autuada": self.selecao_dialogo.comboAreaAutuada,
            "Ãrea de supressÃ£o": self.selecao_dialogo.comboAreaSupressao,
            "Ãrea de supressÃ£o fora": self.selecao_dialogo.comboAreaSupressaoFora,
            "Ãrea de supressÃ£o em APP": self.selecao_dialogo.comboAreaSupressaoAPP,
            "Ãrea de supressÃ£o em RL": self.selecao_dialogo.comboAreaSupressaoRL,
            "Ãrea de vereda": self.selecao_dialogo.comboAreaVereda,
            "Ãrea embargada": self.selecao_dialogo.comboEmbargada,
            "Ãrea Ãºmida": self.selecao_dialogo.comboAreaUmida,
            "Dano": self.selecao_dialogo.comboDano,
            "Unidade de conservaÃ§Ã£o": self.selecao_dialogo.comboUC,
            "Ãrea do imÃ³vel": self.selecao_dialogo.comboAreaImovel,
            "Reserva legal": self.selecao_dialogo.comboRL,
            "Ãrea de PreservaÃ§Ã£o Permanente": self.selecao_dialogo.comboAPP,
            "Ãrea de uso restrito": self.selecao_dialogo.comboAreaUsoRestrito,
            "Ãrea licenciada": self.selecao_dialogo.comboAreaLicenciada,
            "Centroides": self.selecao_dialogo.comboCentroides,
            "ServidÃ£o Administrativa": self.selecao_dialogo.comboServidao,
            "Camada01": self.selecao_dialogo.comboCamada01,
            "Camada02": self.selecao_dialogo.comboCamada02,
            "Camada03": self.selecao_dialogo.comboCamada03,
            "Camada04": self.selecao_dialogo.comboCamada04,
        }

        for novo_nome, combo in mapping.items():
            nome_layer = combo.currentText()
            if nome_layer != "Selecione...":
                layer = self.get_layer_by_name(nome_layer)
                if layer:
                    print(f">> Renomeando camada '{nome_layer}' para '{novo_nome}'")
                    layer.setName(novo_nome)
                    self.aplicar_estilo(layer, novo_nome)
                else:
                    print(f">> Camada '{nome_layer}' nÃ£o encontrada no projeto.")

        self.selecao_dialogo.close()

    # ----------------------------------------------------------------------
    def aplicar_estilo(self, layer, nome_logico):
        """Aplica o estilo QML correspondente ao nome lÃ³gico da camada."""
        from qgis.core import (
            QgsPalLayerSettings,
            QgsVectorLayerSimpleLabeling,
            QgsTextFormat,
            QgsTextBufferSettings,
            QgsNullSymbolRenderer
        )

        estilos_dict = {
            "Ãrea do imÃ³vel": "Area do imovel.qml",
            "Ãrea de PreservaÃ§Ã£o Permanente": "APP Total.qml",
            "Reserva legal": "Reserva legal.qml",
            "Ãrea de supressÃ£o": "Area de supressao.qml",
            "Ãrea de supressÃ£o fora": "Area de supressao.qml",
            "Ãrea de supressÃ£o em APP": "Area de supressao.qml",
            "Ãrea de supressÃ£o em RL": "Area de supressao.qml",
            "Dano": "Area danificada.qml",
            "Ãrea de uso restrito": "Area de uso restrito.qml",
            "Unidade de conservaÃ§Ã£o": "Unidade de Conservacao.qml",
            "ServidÃ£o Administrativa": "Servidao administrativa.qml",
            "Ãrea licenciada": "Area licenciada.qml",
            "Ãrea embargada": "Areas embargadas.qml",
            "Ãrea autuada": "Areas autuadas.qml",
            "Ãrea de vereda": "Vereda.qml",
            "Ãrea Ãºmida": "Area umida.qml",
        }

        estilo_path = os.path.join(os.path.dirname(__file__), 'assents')

        # Caso especial: centroides
        if nome_logico.lower().startswith("centroides"):
            print(f">> Aplicando estilo especial de labels Ã  camada '{nome_logico}'")
            layer.setRenderer(QgsNullSymbolRenderer())
            label_settings = QgsPalLayerSettings()
            label_settings.drawLabels = True
            label_settings.fieldName = 'id'

            text_format = QgsTextFormat()
            text_format.setSize(10)

            buffer_settings = QgsTextBufferSettings()
            buffer_settings.setEnabled(True)
            buffer_settings.setSize(0.5)
            text_format.setBuffer(buffer_settings)

            label_settings.setFormat(text_format)
            layer.setLabeling(QgsVectorLayerSimpleLabeling(label_settings))
            layer.setLabelsEnabled(True)
            layer.triggerRepaint()
            return

        # Aplicar QML padrÃ£o
        if nome_logico in estilos_dict:
            qml_file = os.path.join(estilo_path, estilos_dict[nome_logico])
            if os.path.exists(qml_file):
                print(f">> Aplicando estilo '{qml_file}' Ã  camada '{nome_logico}'")
                layer.loadNamedStyle(qml_file)
                layer.triggerRepaint()
            else:
                print(f">> Arquivo de estilo nÃ£o encontrado: {qml_file}")
        else:
            print(f">> Nenhum estilo definido para '{nome_logico}'")
